# Module 3: State Management ğŸ—„ï¸

> Learn how to store and retrieve application state using Dapr's state management building block

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                           â•‘
â•‘                    MODULE 3: STATE MANAGEMENT                            â•‘
â•‘                                                                           â•‘
â•‘  Goals:                                                                   â•‘
â•‘  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â•‘
â•‘  â€¢ Understand Dapr state management concepts                             â•‘
â•‘  â€¢ Learn CRUD operations on state                                        â•‘
â•‘  â€¢ Master state consistency and concurrency patterns                    â•‘
â•‘  â€¢ Use transactions for atomic operations                               â•‘
â•‘  â€¢ Configure different state stores                                      â•‘
â•‘                                                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

## Table of Contents

1. [What is State Management?](#what-is-state-management)
2. [State Management Architecture](#state-management-architecture)
3. [Supported State Stores](#supported-state-stores)
4. [Basic State Operations](#basic-state-operations)
5. [Advanced Features](#advanced-features)
6. [Transactions](#transactions)
7. [Configuration](#configuration)
8. [Exercises](#exercises)

---

## What is State Management?

State management in Dapr allows your application to store, retrieve, and delete key-value pairs without being tied to a specific storage backend.

### Why Use Dapr for State?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Without Dapr State Management                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   Service   â”‚         â”‚   Service   â”‚         â”‚   Service   â”‚        â”‚
â”‚  â”‚     A       â”‚         â”‚     B       â”‚         â”‚     C       â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚         â”‚                       â”‚                       â”‚              â”‚
â”‚         â”‚  Redis Library        â”‚  Redis Library       â”‚  Redis       â”‚
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Library      â”‚
â”‚         â”‚                       â”‚                       â”‚              â”‚
â”‚         â–¼                       â–¼                       â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Redis SDK   â”‚         â”‚ Redis SDK   â”‚         â”‚ Redis SDK   â”‚        â”‚
â”‚  â”‚ - Connectionâ”‚         â”‚ - Connectionâ”‚         â”‚ - Connectionâ”‚       â”‚
â”‚  â”‚ - Retry     â”‚         â”‚ - Retry     â”‚         â”‚ - Retry     â”‚       â”‚
â”‚  â”‚ - Serial    â”‚         â”‚ - Serial    â”‚         â”‚ - Serial    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚         â”‚                       â”‚                       â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                 â”‚                                      â”‚
â”‚                                 â–¼                                      â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚                         â”‚   Redis     â”‚                               â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                                                          â”‚
â•‘  Problem: Vendor lock-in, repeated code, hard to switch stores         â•‘
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      With Dapr State Management                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   Service   â”‚         â”‚   Service   â”‚         â”‚   Service   â”‚        â”‚
â”‚  â”‚     A       â”‚         â”‚     B       â”‚         â”‚     C       â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚         â”‚                       â”‚                       â”‚              â”‚
â”‚         â”‚ Dapr Client           â”‚ Dapr Client           â”‚ Dapr Client   â”‚
â”‚         â”‚ save_state()          â”‚ save_state()          â”‚ save_state()  â”‚
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼              â”‚
â”‚         â–¼                       â–¼                       â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Dapr Sidecarâ”‚         â”‚ Dapr Sidecarâ”‚         â”‚ Dapr Sidecarâ”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚         â”‚                       â”‚                       â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                 â”‚                                      â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                         â”‚  Dapr Runtime  â”‚                            â”‚
â”‚                         â”‚  (Abstraction) â”‚                            â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                 â”‚                                      â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                    â”‚            â”‚            â”‚                         â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”                    â”‚
â”‚              â”‚  Redis   â”‚  â”‚PostgreSQLâ”‚  â”‚  Azure  â”‚                  â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  Cosmos   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                                                          â”‚
â•‘  Benefit: Switch stores with config change, no code change!            â•‘
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## State Management Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    State Management Request Flow                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        Your Application                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  dapr.save_state(store_name="mystore", key="user:1")   â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â”‚ gRPC/HTTP                          â”‚
â”‚                                  â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         Dapr Sidecar                             â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  State Store Component (mystore)                         â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - Applies ETag check                                    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - Applies TTL                                           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - Serializes/Deserializes                               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - Handles retry logic                                    â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                           â”‚                             â”‚
â”‚                                           â–¼                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      State Store Backend                         â”‚   â”‚
â”‚  â”‚                    (Redis, PostgreSQL, etc.)                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Supported State Stores

Dapr supports a wide variety of state stores:

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      Supported State Stores                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                          â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
â•‘  â”‚  IN-MEMORY                                                       â”‚    â•‘
â•‘  â”‚  â€¢ In-Memory (Redis)                                             â”‚    â•‘
â•‘  â”‚  â€¢ Memcached                                                      â”‚    â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
â•‘                                                                          â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
â•‘  â”‚  SQL DATABASES                                                    â”‚    â•‘
â•‘  â”‚  â€¢ PostgreSQL                                                    â”‚    â•‘
â•‘  â”‚  â€¢ MySQL                                                         â”‚    â•‘
â•‘  â”‚  â€¢ SQL Server                                                    â”‚    â•‘
â•‘  â”‚  â€¢ MariaDB                                                       â”‚    â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
â•‘                                                                          â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
â•‘  â”‚  NOSQL DATABASES                                                  â”‚    â•‘
â•‘  â”‚  â€¢ Redis                                                         â”‚    â•‘
â•‘  â”‚  â€¢ MongoDB                                                       â”‚    â•‘
â•‘  â”‚  â€¢ Cassandra                                                     â”‚    â•‘
â•‘  â”‚  â€¢ ScyllaDB                                                      â”‚    â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
â•‘                                                                          â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
â•‘  â”‚  CLOUD NATIVE                                                    â”‚    â•‘
â•‘  â”‚  â€¢ Azure Cosmos DB                                               â”‚    â•‘
â•‘  â”‚  â€¢ Azure Table Storage                                           â”‚    â•‘
â•‘  â”‚  â€¢ AWS DynamoDB                                                  â”‚    â•‘
â•‘  â”‚  â€¢ Google Cloud Datastore                                       â”‚    â•‘
â•‘  â”‚  â€¢ GCP Firestore                                                 â”‚    â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
â•‘                                                                          â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
â•‘  â”‚  OTHERS                                                          â”‚    â•‘
â•‘  â”‚  â€¢ Aerospike                                                     â”‚    â•‘
â•‘  â”‚  â€¢ Couchbase                                                     â”‚    â•‘
â•‘  â”‚  â€¢ etcd                                                          â”‚    â•‘
â•‘  â”‚  â€¢ HashiCorp Consul                                             â”‚    â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
â•‘                                                                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## Basic State Operations

### Setup

First, create a Redis component configuration:

```yaml
# .dapr/components/statestore.yaml
apiVersion: dapr.io/v1
kind: Component
metadata:
  name: statestore
  namespace: default
spec:
  type: state.redis
  version: v1
  initTimeout: 1m
  metadata:
  - name: redisHost
    value: localhost:6379
  - name: redisPassword
    value: ""
  - name: enableTLS
    value: "false"
  - name: failover
    value: "false"
```

### 1. Save State

```python
from dapr.clients import DaprClient
import json

# Simple string value
with DaprClient() as dapr:
    dapr.save_state(
        store_name="statestore",
        key="user:1:name",
        value="Alice"
    )

# JSON object
user_data = {
    "name": "Alice",
    "email": "alice@example.com",
    "age": 30
}
dapr.save_state(
    store_name="statestore",
    key="user:1",
    value=json.dumps(user_data)
)
```

### 2. Get State

```python
from dapr.clients import DaprClient

with DaprClient() as dapr:
    # Get state
    state = dapr.get_state(store_name="statestore", key="user:1:name")

    if state.data:
        print(f"Name: {state.json()}")
    else:
        print("State not found")
```

### 3. Delete State

```python
from dapr.clients import DaprClient

with DaprClient() as dapr:
    dapr.delete_state(store_name="statestore", key="user:1")
```

### 4. Bulk Operations

```python
from dapr.clients import DaprClient

with DaprClient() as dapr:
    # Save multiple states
    states = [
        ("user:1", json.dumps({"name": "Alice", "age": 30})),
        ("user:2", json.dumps({"name": "Bob", "age": 25})),
        ("user:3", json.dumps({"name": "Charlie", "age": 35})),
    ]

    for key, value in states:
        dapr.save_state(store_name="statestore", key=key, value=value)

    # Get multiple states
    keys = ["user:1", "user:2", "user:3"]
    items = dapr.get_bulk_state(store_name="statestore", keys=keys)

    for item in items:
        print(f"{item.key}: {item.json()}")

    # Delete multiple states
    for key in keys:
        dapr.delete_state(store_name="statestore", key=key)
```

---

## Advanced Features

### 1. ETags (Optimistic Concurrency)

ETags prevent concurrent modifications from overwriting each other:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Optimistic Concurrency with ETags                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  Client A                               Client B                          â”‚
â”‚     â”‚                                      â”‚                             â”‚
â”‚     â”‚ GET user:1 (ETag: v1)                â”‚                             â”‚
â”‚     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                             â”‚
â”‚     â”‚                                      â”‚                             â”‚
â”‚     â”‚ {balance: 100, ETag: v1}             â”‚                             â”‚
â”‚     â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                             â”‚
â”‚     â”‚                                      â”‚                             â”‚
â”‚     â”‚ balance += 50                        â”‚                             â”‚
â”‚     â”‚                                      â”‚ GET user:1 (ETag: v1)        â”‚
â”‚     â”‚                                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
â”‚     â”‚                                      â”‚                             â”‚
â”‚     â”‚                                      â”‚ {balance: 100, ETag: v1}     â”‚
â”‚     â”‚                                      â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     â”‚                                      â”‚                             â”‚
â”‚     â”‚ PUT user:1 (ETag: v1, balance: 150)   â”‚ balance += 20               â”‚
â”‚     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                             â”‚
â”‚     â”‚ â—„â”€ SUCCESS                           â”‚                             â”‚
â”‚     â”‚ (New ETag: v2)                       â”‚                             â”‚
â”‚     â”‚                                      â”‚ PUT user:1 (ETag: v1,       â”‚
â”‚     â”‚                                      â”‚       balance: 120)          â”‚
â”‚     â”‚                                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
â”‚     â”‚                                      â”‚ â—„â”€ CONFLICT (ETag mismatch)â”‚
â”‚     â”‚                                      â”‚                             â”‚
â•‘  Client B must fetch new state and retry                           â•‘
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```python
from dapr.clients import DaprClient
from dapr.clients.grpc._state import StateItem
import json

with DaprClient() as dapr:
    # Get current state
    state = dapr.get_state(store_name="statestore", key="account:1")
    account = json.loads(state.json())
    current_etag = state.etag

    print(f"Current: {account}, ETag: {current_etag}")

    # Modify with optimistic concurrency
    account["balance"] += 50

    try:
        dapr.save_state(
            store_name="statestore",
            key="account:1",
            value=json.dumps(account),
            etag=current_etag  # Use the ETag we got
        )
        print("Update successful!")
    except Exception as e:
        print(f"Conflict! Someone else modified the state. Error: {e}")
```

### 2. TTL (Time to Live)

Automatically expire state after a specified time:

```python
from dapr.clients import DaprClient
from dapr.clients.grpc._state import StateItem, StateOptions
from datetime import timedelta
import json

with DaprClient() as dapr:
    # Save state with TTL of 1 hour
    options = StateOptions(
        metadata={
            "ttlInSeconds": "3600"  # 1 hour
        }
    )

    dapr.save_state(
        store_name="statestore",
        key="session:abc123",
        value=json.dumps({"user_id": "1", "expires_at": "1h"}),
        state_options=options
    )

    print("State saved with 1 hour TTL")
```

### 3. State Metadata

Additional metadata that can be attached to state:

```python
from dapr.clients import DaprClient
from dapr.clients.grpc._state import StateOptions

with DaprClient() as dapr:
    options = StateOptions(
        metadata={
            "ttlInSeconds": "3600",
            "secondaryIndex": "user_id:123",
            "createdBy": "serviceA",
            "contentType": "application/json"
        }
    )

    dapr.save_state(
        store_name="statestore",
        key="document:456",
        value="document content",
        state_options=options
    )
```

### 4. Consistency Levels

Dapr supports different consistency models:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      State Consistency Levels                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â•‘  STRONG                   EVENTUAL                   CABOA               â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â•‘
â•‘  â”‚   All   â”‚              â”‚   Any   â”‚              â”‚   Quorumâ”‚          â•‘
â•‘  â”‚  nodes  â”‚              â”‚  node   â”‚              â”‚  nodes  â”‚          â•‘
â•‘  â”‚   sync  â”‚              â”‚  write  â”‚              â”‚   sync  â”‚          â•‘
â•‘  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â•‘
â•‘       â”‚                        â”‚                        â”‚                â•‘
â•‘       â–¼                        â–¼                        â–¼                â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â•‘
â•‘   â”‚ 100%    â”‚              â”‚ Fast    â”‚              â”‚ Balancedâ”‚         â•‘
â•‘   â”‚ Accurateâ”‚              â”‚ No sync â”‚              â”‚  sync   â”‚         â•‘
â•‘   â”‚  Slow   â”‚              â”‚         â”‚              â”‚         â”‚         â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â•‘
â•‘                                                                          â•‘
â•‘  â€¢ STRONG:  Wait for all replicas to acknowledge                         â•‘
â•‘  â€¢ EVENTUAL: Write succeeds without waiting for replicas                 â•‘
â•‘  â€¢ CABOA: Converge Aggressive Bounded Availability                       â•‘
â•‘                                                                          â•‘
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```python
from dapr.clients import DaprClient
from dapr.clients.grpc._state import StateOptions, Consistency

with DaprClient() as dapr:
    options = StateOptions(
        consistency=Consistency.STRONG  # STRONG, EVENTUAL, or CABOA
    )

    dapr.save_state(
        store_name="statestore",
        key="critical:data",
        value="important_data",
        state_options=options
    )
```

---

## Transactions

Transactions allow you to perform multiple state operations atomically.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Transaction Flow                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Application                                                     â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚  START TRANSACTION                                        â”‚    â”‚    â”‚
â”‚  â”‚  â”‚    Operation 1: Save A                                   â”‚    â”‚    â”‚
â•‘  â”‚  â”‚    Operation 2: Save B                                   â”‚    â”‚    â•‘
â•‘  â”‚  â”‚    Operation 3: Delete C                                 â”‚    â”‚    â•‘
â•‘  â”‚  â”‚  COMMIT TRANSACTION                                      â”‚    â”‚    â•‘
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                           â”‚                             â”‚
â”‚                                           â–¼                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Dapr Sidecar                                                    â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚  If all operations succeed:                              â”‚    â”‚    â”‚
â”‚  â”‚  â”‚    Apply all changes to state store                       â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  If any operation fails:                                 â”‚    â”‚    â”‚
â•‘  â”‚  â”‚    Rollback ALL changes (no partial state)               â”‚    â”‚    â•‘
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Transaction Example

```python
from dapr.clients import DaprClient
from dapr.clients.grpc._state import StateItem, TransactionOperationType
import json

def transfer_money(from_account: str, to_account: str, amount: float):
    with DaprClient() as dapr:
        # Get current balances
        from_state = dapr.get_state(store_name="statestore", key=f"account:{from_account}")
        to_state = dapr.get_state(store_name="statestore", key=f"account:{to_account}")

        from_balance = json.loads(from_state.json())["balance"] if from_state.data else 0
        to_balance = json.loads(to_state.json())["balance"] if to_state.data else 0

        if from_balance < amount:
            raise ValueError("Insufficient funds")

        # Create transaction operations
        operations = [
            TransactionOperationType(
                operation_type="upsert",
                request=StateItem(
                    key=f"account:{from_account}",
                    value=json.dumps({"balance": from_balance - amount}),
                    etag=from_state.etag
                )
            ),
            TransactionOperationType(
                operation_type="upsert",
                request=StateItem(
                    key=f"account:{to_account}",
                    value=json.dumps({"balance": to_balance + amount}),
                    etag=to_state.etag
                )
            )
        ]

        # Execute transaction atomically
        dapr.execute_transaction(store_name="statestore", operations=operations)

        print(f"Transferred {amount} from {from_account} to {to_account}")

# Usage
transfer_money("123", "456", 100)
```

---

## Complete Example: Shopping Cart

```python
from fastapi import FastAPI, HTTPException
from pydantic import BaseModel
from typing import List, Optional
from dapr.clients import DaprClient
import json

app = FastAPI(title="Shopping Cart Service")

class CartItem(BaseModel):
    product_id: str
    name: str
    price: float
    quantity: int

class Cart(BaseModel):
    items: List[CartItem]

@app.get("/cart/{user_id}")
def get_cart(user_id: str):
    with DaprClient() as dapr:
        state = dapr.get_state(store_name="statestore", key=f"cart:{user_id}")

        if not state.data:
            return Cart(items=[])

        return Cart(items=json.loads(state.json()))

@app.post("/cart/{user_id}/add")
def add_to_cart(user_id: str, item: CartItem):
    with DaprClient() as dapr:
        # Get existing cart
        state = dapr.get_state(store_name="statestore", key=f"cart:{user_id}")
        cart = json.loads(state.json()) if state.data else []

        # Check if item already exists
        for cart_item in cart:
            if cart_item["product_id"] == item.product_id:
                cart_item["quantity"] += item.quantity
                break
        else:
            cart.append(item.model_dump())

        # Save with 24 hour TTL
        from dapr.clients.grpc._state import StateOptions
        options = StateOptions(metadata={"ttlInSeconds": "86400"})

        dapr.save_state(
            store_name="statestore",
            key=f"cart:{user_id}",
            value=json.dumps(cart),
            state_options=options
        )

        return {"message": "Item added", "cart": cart}

@app.delete("/cart/{user_id}")
def clear_cart(user_id: str):
    with DaprClient() as dapr:
        dapr.delete_state(store_name="statestore", key=f"cart:{user_id}")
        return {"message": "Cart cleared"}

@app.post("/cart/{user_id}/checkout")
def checkout(user_id: str):
    with DaprClient() as dapr:
        # Get cart
        state = dapr.get_state(store_name="statestore", key=f"cart:{user_id}")

        if not state.data:
            raise HTTPException(status_code=404, detail="Cart is empty")

        cart = json.loads(state.json())
        total = sum(item["price"] * item["quantity"] for item in cart)

        # Create order using transaction
        from dapr.clients.grpc._state import TransactionOperationType, StateItem

        operations = [
            TransactionOperationType(
                operation_type="upsert",
                request=StateItem(
                    key=f"order:{user_id}:{hash(json.dumps(cart))}",
                    value=json.dumps({
                        "user_id": user_id,
                        "items": cart,
                        "total": total,
                        "status": "pending"
                    })
                )
            ),
            TransactionOperationType(
                operation_type="delete",
                request=StateItem(key=f"cart:{user_id}")
            )
        ]

        dapr.execute_transaction(store_name="statestore", operations=operations)

        return {"message": "Order placed", "order_id": f"order:{user_id}", "total": total}
```

---

## Configuration

### Redis State Store

```yaml
# .dapr/components/redis-state.yaml
apiVersion: dapr.io/v1
kind: Component
metadata:
  name: statestore
  namespace: default
spec:
  type: state.redis
  version: v1
  metadata:
  - name: redisHost
    value: localhost:6379
  - name: redisPassword
    value: ""
  - name: enableTLS
    value: "false"
  - name: keyPrefix
    value: none  # Options: none, appid, name
  - name: failover
    value: "false"
  - name: maxRetries
    value: "3"
  - name: maxRetryBackoff
    value: "2000ms"
```

### PostgreSQL State Store

```yaml
# .dapr/components/postgres-state.yaml
apiVersion: dapr.io/v1
kind: Component
metadata:
  name: statestore
  namespace: default
spec:
  type: state.postgresql
  version: v1
  metadata:
  - name: connectionString
    secretKeyRef:
      name: postgres-connection
      key: connection-string
  - name: tablePrefix
    value: dapr_
  - name: cleanupIntervalInSeconds
    value: "3600"
  - name: maxIdleConns
    value: "10"
  - name: maxOpenConns
    value: "100"
```

### Azure Cosmos DB State Store

```yaml
# .dapr/components/cosmos-state.yaml
apiVersion: dapr.io/v1
kind: Component
metadata:
  name: statestore
  namespace: default
spec:
  type: state.azure.cosmosdb
  version: v1
  metadata:
  - name: url
    secretKeyRef:
      name: cosmos-db-url
      key: url
  - name: masterKey
    secretKeyRef:
      name: cosmos-db-master-key
      key: masterKey
  - name: database
    value: "dapr-state"
  - name: collection
    value: "state"
```

---

## Exercises

### Exercise 1: Todo List with State
1. Create a Todo service using Dapr state
2. Implement endpoints:
   - Create todo
   - List todos
   - Update todo
   - Delete todo
   - Mark todo as complete
3. Use ETags for safe updates

### Exercise 2: Leaderboard
1. Create a game leaderboard service
2. Store player scores with TTL of 24 hours
3. Implement:
   - Add score
   - Get top 10 players
   - Get player rank
4. Use transactions for score updates

### Exercise 3: Switch State Stores
1. Build a service using Redis state store
2. Change the component to use PostgreSQL
3. Verify no code changes are needed

---

## Summary

In this module, you learned:

- Dapr state management architecture
- Basic CRUD operations
- ETags for optimistic concurrency
- TTL for expiring state
- Transactions for atomic operations
- Multiple state store options

### Next Steps

Continue to [Module 4: Pub/Sub](../04-pubsub/README.md) to learn about event-driven architecture.
